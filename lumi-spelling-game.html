<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§© æ‹¼åœ–å–®å­—å†’éšª ğŸ§©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&family=Kosugi+Maru&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', 'Kosugi Maru', 'Noto Sans TC', sans-serif;
            background-color: #FFFBE8;
            color: #5d5d5d;
            background-image: radial-gradient(#f2cc8f 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .lowercase-text { text-transform: lowercase; }

        /* 3D éµç›¤æŒ‰éˆ• */
        .key-btn {
            background-color: white;
            border: 2px solid #f2cc8f;
            border-bottom: 6px solid #d4a373;
            color: #e07a5f;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.5rem;
            transition: all 0.1s ease;
            position: relative;
        }
        
        /* å…ƒéŸ³æŒ‰éˆ•æ·¡é»ƒè‰²åº•è‰² */
        .key-vowel {
            background-color: #fdf2b3;
            border-color: #e9c46a;
            border-bottom-color: #d4a373;
        }

        .key-btn:disabled {
            opacity: 0.15;
            border-bottom-width: 2px;
            top: 4px;
            filter: grayscale(100%);
        }

        /* é˜²æ­¢å–®å­—æ–·è¡Œæ»¾å‹•æ¢ */
        #word-display {
            white-space: nowrap;
            overflow-x: auto;
            max-width: 90vw;
            padding: 10px 10px;
            scrollbar-width: thin;
            scrollbar-color: #f2cc8f transparent;
        }

        .puzzle-slice {
            height: 100%;
            background-repeat: no-repeat;
            opacity: 0.1;
            transition: opacity 0.5s ease;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            box-sizing: border-box;
        }

        /* ğŸŒ¸ ä¿®æ­£ï¼šå›é¥‹å®¹å™¨èˆ‡å­—æ¯çµ•å°ç½®ä¸­ ğŸŒ¸ */
        .feedback-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 360px;
            height: 360px;
            overflow: visible;
        }
        #feedback-letter {
            font-size: 6.5rem; /* ç¨å¾®ç¸®å°ä»¥ç¢ºä¿å¯¬å­—æ¯å¦‚ m ä¹Ÿèƒ½å®Œç¾ç½®ä¸­ */
            font-weight: 700;
            color: #3d405b;
            z-index: 10;
            line-height: 1 !important; /* ç§»é™¤å¤šé¤˜è¡Œé«˜ */
            letter-spacing: 0 !important; /* å¼·åˆ¶å–æ¶ˆå­—è·åç§» */
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        #feedback-mark {
            position: absolute;
            inset: -20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        
        /* èª²ç¨‹æ”¶åˆé¸å–® */
        details summary {
            list-style: none;
            cursor: pointer;
            @apply flex items-center justify-between p-3 bg-white rounded-xl border-2 border-[#f2cc8f] mb-2 font-bold text-[#e07a5f];
        }
        details[open] summary { @apply bg-orange-50 border-b-0 rounded-b-none mb-0; }
        .unit-list { @apply bg-white border-2 border-t-0 border-[#f2cc8f] rounded-b-xl p-3 mb-2 grid grid-cols-1 gap-2; }

        @keyframes pulse-btn {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .next-btn-animation {
            animation: pulse-btn 2s infinite ease-in-out;
        }

        .pronounce-btn {
            @apply transition-all duration-150 active:scale-90 hover:brightness-110 shadow-md;
            border-bottom-width: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <header class="text-center my-4">
        <h1 class="text-4xl font-bold text-[#e07a5f] tracking-widest drop-shadow-sm">ğŸ§© æ‹¼åœ–å–®å­—å†’éšª ğŸ§©</h1>
    </header>

    <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="text-7xl mb-6">ğŸ¹</div>
        <p class="text-xl font-bold text-[#d4a373]">æ­£åœ¨åŒæ­¥å†’éšªåœ°åœ–...å¼“ç®­æ‰‹æ•´è£å¾…ç™¼!</p>
    </div>

    <div id="start-screen" class="hidden bg-white/90 p-6 rounded-[40px] shadow-2xl max-w-lg w-full mt-4 border-b-8 border-[#f2cc8f]">
        <div class="mb-6">
            <h2 class="text-lg font-bold text-[#3d405b] mb-3 flex items-center">
                <span class="mr-2">ğŸ—ºï¸</span> é¸æ“‡å†’éšªåœ°åœ–
            </h2>
            <div id="lesson-selector" class="max-h-80 overflow-y-auto pr-2"></div>
        </div>

        <h2 class="text-lg font-bold text-[#3d405b] mb-4 text-center">è¦æŒ‘æˆ°å¹¾é¡Œå‘¢ï¼Ÿ</h2>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="startGame(5)" class="bg-[#81b29a] text-white py-3 rounded-2xl font-bold shadow-md hover:brightness-105 transition-all">5 é¡Œ</button>
            <button onclick="startGame(10)" class="bg-[#f2cc8f] text-white py-3 rounded-2xl font-bold shadow-md hover:brightness-105 transition-all">10 é¡Œ</button>
            <button onclick="startGame(15)" class="bg-[#e07a5f] text-white py-3 rounded-2xl font-bold shadow-md hover:brightness-105 transition-all">15 é¡Œ</button>
            <button onclick="startGame(20)" class="bg-[#3d405b] text-white py-3 rounded-2xl font-bold shadow-md hover:brightness-105 transition-all">ğŸ”¥ 20 é¡Œ</button>
        </div>
    </div>

    <div id="game-screen" class="hidden w-full max-w-xl flex flex-col items-center">
        <div class="w-full flex justify-between px-6 mb-4 font-bold text-[#3d405b]">
            <span class="bg-white/80 px-4 py-1 rounded-full text-sm">Question: <span id="current-index">1</span></span>
            <span class="bg-[#81b29a] text-white px-4 py-1 rounded-full text-sm">åˆ†æ•¸: <span id="score">0</span></span>
        </div>

        <div id="puzzle-box" class="relative w-72 h-72 md:w-80 md:h-80 bg-white rounded-[40px] shadow-2xl border-[8px] border-white overflow-hidden mb-6">
            <div id="full-image" class="absolute inset-0 bg-cover bg-center opacity-0 transition-opacity duration-1000 z-10"></div>
            <div id="puzzle-slices-container" class="absolute inset-0 flex z-20"></div>
        </div>

        <div class="flex items-center space-x-4 mb-8">
            <div id="word-display" class="text-5xl tracking-[0.3em] font-bold text-[#3d405b] min-h-[1.2em]"></div>
            <button onclick="speakWord()" class="pronounce-btn bg-[#81b29a] text-white p-3 rounded-full border-b-4 border-[#5a8a70]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
            </button>
        </div>
        
        <div id="keyboard-container" class="flex flex-col items-center w-full max-w-md px-2 pb-6 space-y-4">
            <div id="vowel-row" class="flex justify-center space-x-2 w-full"></div>
            <div id="consonant-grid" class="grid grid-cols-7 gap-2 w-full"></div>
        </div>

        <button id="manual-next-btn" class="hidden mt-4 bg-[#81b29a] text-white px-8 py-4 rounded-full font-bold text-xl shadow-lg next-btn-animation flex items-center space-x-2" onclick="nextQuestion()">
            <span>ä¸‹ä¸€é¡Œ</span>
            <span class="text-2xl">â¡ï¸</span>
        </button>
    </div>

    <div id="result-screen" class="hidden bg-white p-8 rounded-[40px] shadow-2xl text-center max-md w-full border-b-8 border-[#81b29a] mt-10">
        <h2 class="text-3xl font-bold mb-4 text-[#e07a5f]">å†’éšªé”æˆï¼ğŸ†</h2>
        <p class="text-5xl font-black text-[#81b29a] mb-6"><span id="final-score">0</span> åˆ†</p>
        <div class="text-left mb-8 bg-gray-50 p-4 rounded-2xl max-h-60 overflow-y-auto">
            <h3 class="font-bold text-[#3d405b] mb-2 border-b border-gray-200 pb-1">æœ¬æ¬¡å†’éšªå›é¡§ï¼š</h3>
            <ul id="word-summary-list" class="space-y-1 text-lg"></ul>
        </div>
        <button onclick="location.reload()" class="w-full bg-[#3d405b] text-white py-4 rounded-2xl text-xl font-bold shadow-lg">å›åˆ°é¦–é </button>
    </div>

    <div id="feedback-overlay" class="fixed inset-0 hidden flex items-center justify-center z-50 pointer-events-none bg-black/10 backdrop-blur-[2px]">
        <div class="feedback-container bg-white rounded-full shadow-2xl border-8 border-white">
            <span id="feedback-letter" class="lowercase-text">a</span>
            <div id="feedback-mark"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby2ovgPvLdkW7ny_Kql4h_x2YW7bmR1rLXhomGv63oSCmS2ENG3CA7istlAYUcH-aYe4g/exec";
        
        let allWords = []; 
        let filteredWords = []; 
        let gameConfig = { total: 5, current: 0, score: 0, usedIndices: [] };
        let history = []; 
        let originalWord = ""; 
        let currentWordLower = ""; 
        let guessedLetters = [];
        let currentWordErrors = 0;
        let isProcessing = false;

        window.onload = async () => {
            try {
                const response = await fetch(API_URL);
                allWords = await response.json();
                buildLessonMenu();
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('start-screen').classList.remove('hidden');
            } catch (error) {
                console.error("è¼‰å…¥å¤±æ•—", error);
            }
        };

        function speakWord() {
            if (!originalWord) return;
            const msg = new SpeechSynthesisUtterance();
            msg.text = originalWord;
            msg.lang = 'en-US';
            msg.rate = 0.8; 
            window.speechSynthesis.speak(msg);
        }

        function buildLessonMenu() {
            const menu = document.getElementById('lesson-selector');
            const lessons = {};
            const unitStatus = {}; 
            allWords.forEach(w => {
                const parts = (w.lesson || "å…¶ä»–-é è¨­").split('-');
                const kw = parts[0];
                const unit = parts[1];
                if (!lessons[kw]) lessons[kw] = new Set();
                lessons[kw].add(unit);
                const key = `${kw}-${unit}`;
                if (!w.img || w.img.trim() === "") unitStatus[key] = true;
            });

            let html = "";
            Object.keys(lessons).sort((a,b) => a.localeCompare(b, undefined, {numeric: true})).forEach(kw => {
                const sortedUnits = Array.from(lessons[kw]).sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
                html += `
                <details class="mb-2">
                    <summary>
                        <span>${kw}</span>
                        <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="unit-list">
                        <div class="flex items-center mb-1 pb-1 border-b border-gray-100">
                            <input type="checkbox" class="kw-check w-5 h-5 rounded" data-kw="${kw}" checked onchange="toggleKW('${kw}', this.checked)">
                            <label class="ml-2 font-bold text-gray-400 text-xs">å…¨é¸</label>
                        </div>
                        ${sortedUnits.map(unit => {
                            const isPending = unitStatus[`${kw}-${unit}`];
                            return `
                            <div class="flex items-center">
                                <input type="checkbox" class="unit-check w-4 h-4 rounded" data-kw="${kw}" data-unit="${unit}" ${isPending ? 'disabled' : 'checked'}>
                                <label class="ml-2 text-sm ${isPending ? 'text-gray-400 italic' : 'text-gray-600'}">
                                    ${unit} ${isPending ? '(æº–å‚™ä¸­)' : ''}
                                </label>
                            </div>`;
                        }).join('')}
                    </div>
                </details>`;
            });
            menu.innerHTML = html;
        }

        function toggleKW(kw, isChecked) {
            document.querySelectorAll(`.unit-check[data-kw="${kw}"]`).forEach(u => {
                if (!u.disabled) u.checked = isChecked;
            });
        }

        function startGame(num) {
            const selected = Array.from(document.querySelectorAll('.unit-check:checked')).map(el => ({kw: el.dataset.kw, unit: el.dataset.unit}));
            if (selected.length === 0) return alert("è«‹å…ˆé¸æ“‡è¦å†’éšªçš„åœ°åœ–å–®å…ƒï¼");
            filteredWords = allWords.filter(w => {
                const parts = (w.lesson || "å…¶ä»–-é è¨­").split('-');
                return selected.some(u => u.kw === parts[0] && u.unit === parts[1]) && w.img;
            });
            gameConfig.total = Math.min(num, filteredWords.length);
            gameConfig.current = 0; gameConfig.score = 0; gameConfig.usedIndices = []; history = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            initKeyboard();
            nextQuestion();
        }

        function initKeyboard() {
            const vowelRow = document.getElementById('vowel-row');
            const consonantGrid = document.getElementById('consonant-grid');
            vowelRow.innerHTML = ''; consonantGrid.innerHTML = '';
            const vowels = "aeiou".split('');
            const consonants = "bcdfghjklmnpqrstvwxyz".split('');
            vowels.forEach(char => vowelRow.appendChild(createKeyBtn(char, true)));
            consonants.forEach(char => consonantGrid.appendChild(createKeyBtn(char, false)));
        }

        function createKeyBtn(char, isVowel) {
            const btn = document.createElement('button');
            btn.innerText = char;
            btn.className = `key-btn h-14 w-14 ${isVowel ? 'key-vowel' : ''}`;
            btn.id = `key-${char}`;
            btn.onclick = () => handleGuess(char);
            return btn;
        }

        function nextQuestion() {
            document.getElementById('manual-next-btn').classList.add('hidden');
            document.getElementById('keyboard-container').classList.remove('hidden');
            let available = filteredWords.filter((_, i) => !gameConfig.usedIndices.includes(i));
            if (available.length === 0 || gameConfig.current >= gameConfig.total) return endGame();
            const randomIdx = Math.floor(Math.random() * available.length);
            gameConfig.usedIndices.push(filteredWords.indexOf(available[randomIdx]));
            originalWord = available[randomIdx].word;
            currentWordLower = originalWord.toLowerCase();
            guessedLetters = currentWordLower.split('').filter(char => !/[a-z]/.test(char));
            currentWordErrors = 0; gameConfig.current++;
            document.getElementById('current-index').innerText = `${gameConfig.current} / ${gameConfig.total}`;
            document.getElementById('score').innerText = gameConfig.score;
            document.getElementById('full-image').style.opacity = '0';
            document.getElementById('puzzle-slices-container').style.opacity = '1';
            resetKeyboardVisuals();
            updateDisplay();
            setupPuzzle(available[randomIdx].img);
        }

        function setupPuzzle(imgUrl) {
            const container = document.getElementById('puzzle-slices-container');
            container.innerHTML = '';
            const boxSize = document.getElementById('puzzle-box').clientWidth;
            const lettersOnly = currentWordLower.replace(/[^a-z]/g, "");
            const totalSlices = lettersOnly.length;
            const sliceWidth = boxSize / (totalSlices || 1);
            const img = new Image();
            img.onload = () => {
                let sliceIdx = 0;
                for (let i = 0; i < currentWordLower.length; i++) {
                    const char = currentWordLower[i];
                    if (/[a-z]/.test(char)) {
                        const slice = document.createElement('div');
                        slice.className = "puzzle-slice";
                        slice.id = `slice-char-${i}`; 
                        slice.style.width = `${sliceWidth}px`;
                        slice.style.backgroundImage = `url('${imgUrl}')`;
                        slice.style.backgroundSize = `${boxSize}px auto`;
                        const bgPosPercent = (sliceIdx / (totalSlices - 1 || 1)) * 100;
                        slice.style.backgroundPosition = `${bgPosPercent}% center`;
                        container.appendChild(slice);
                        sliceIdx++;
                    }
                }
                document.getElementById('full-image').style.backgroundImage = `url('${imgUrl}')`;
            };
            img.src = imgUrl;
        }

        function handleGuess(letter) {
            if (isProcessing) return;
            isProcessing = true;
            const btn = document.getElementById(`key-${letter}`);
            btn.disabled = true;
            const isCorrect = currentWordLower.includes(letter);
            const overlay = document.getElementById('feedback-overlay');
            document.getElementById('feedback-letter').innerText = letter;
            document.getElementById('feedback-mark').innerHTML = isCorrect ? 
                '<svg viewBox="0 0 24 24" fill="none" stroke="#81b29a" stroke-width="2.5" class="w-full h-full drop-shadow-md"><circle cx="12" cy="12" r="10"/><path d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>' : 
                '<svg viewBox="0 0 24 24" fill="none" stroke="#e07a5f" stroke-width="2.5" class="w-full h-full drop-shadow-md"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>';
            overlay.classList.remove('hidden');
            if (!isCorrect) currentWordErrors++;
            setTimeout(() => {
                overlay.classList.add('hidden');
                if (isCorrect) {
                    if (!guessedLetters.includes(letter)) guessedLetters.push(letter);
                    currentWordLower.split('').forEach((char, idx) => { if (char === letter) { const s = document.getElementById(`slice-char-${idx}`); if(s) s.style.opacity = '1'; } });
                    updateDisplay();
                    checkWin();
                } else isProcessing = false;
            }, 800);
        }

        function updateDisplay() {
            const displayStr = originalWord.split('').map((char, idx) => {
                if (char === " ") return "ã€€";
                const lowerChar = char.toLowerCase();
                if (!/[a-z]/i.test(char) || guessedLetters.includes(lowerChar)) return char;
                return "_";
            }).join(' ');
            document.getElementById('word-display').innerText = displayStr;
            const displayEl = document.getElementById('word-display');
            displayEl.scrollLeft = displayEl.scrollWidth;
        }

        function checkWin() {
            const uniqueAlphabetChars = [...new Set(currentWordLower.replace(/[^a-z]/g, "").split(''))];
            const isComplete = uniqueAlphabetChars.every(c => guessedLetters.includes(c));
            if (isComplete) {
                history.push({word: originalWord, errors: currentWordErrors});
                gameConfig.score += 10;
                document.getElementById('full-image').style.opacity = '1';
                document.getElementById('puzzle-slices-container').style.opacity = '0'; 
                isProcessing = false;
                document.getElementById('manual-next-btn').classList.remove('hidden');
                document.getElementById('keyboard-container').classList.add('hidden'); 
            } else isProcessing = false;
        }

        function resetKeyboardVisuals() { document.querySelectorAll('.key-btn').forEach(b => b.disabled = false); isProcessing = false; }

        function endGame() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = gameConfig.score;
            const hasErrors = history.filter(h => h.errors > 0).sort((a,b) => b.errors - a.errors);
            const thresholdCount = Math.ceil(history.length * 0.25);
            const redWords = hasErrors.slice(0, thresholdCount).map(h => h.word);
            const listEl = document.getElementById('word-summary-list');
            listEl.innerHTML = history.map(h => {
                const isRed = redWords.includes(h.word);
                const errorText = h.errors > 0 ? ` (éŒ¯ ${h.errors} æ¬¡)` : "";
                return `<li class="${isRed ? 'text-red-500 font-bold' : 'text-gray-700'}">â€¢ ${h.word}${errorText}</li>`;
            }).join('');
        }
    </script>
</body>
</html>